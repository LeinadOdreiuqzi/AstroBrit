---
const GalleryItem = {
  id: "",
  src: "",
  title: "",
  subtitle: "",
};

const Props = {
  items: [],
  columns: 6,
  variant: "hero",
};

const defaultItems = [
  {
    id: "morty-hero",
    src: "/assets/mortySpawn.webp",
    title: "Morty Spawn",
    subtitle: "Galería",
  },
  { id: "mosaic-1", src: "/assets/servi.webp", title: "Imagen 1" },
  { id: "mosaic-2", src: "/assets/servi.webp", title: "Imagen 2" },
  { id: "mosaic-3", src: "assets/servi.webp", title: "Imagen 3" },
  { id: "mosaic-4", src: "assets/servi.webp", title: "Imagen 4" },
  { id: "mosaic-5", src: "assets/servi.webp", title: "Imagen 5" },
];

const {
  items = defaultItems,
  columns = 6,
  variant = items.length === 1 ? "hero" : "mosaic",
} = Astro.props;
---

<section
  class={`gallery gallery--${variant}`}
  aria-label="Galería de imágenes"
  data-items={JSON.stringify(items)}
>
  {
    variant === "hero" ? (
      Astro.slots.has("hero") ? (
        <slot name="hero" />
      ) : (
        <article class="gallery-item gallery-item--hero" data-id={items[0]?.id}>
          <div class="gallery-media">
            <img
              alt={items[0]?.title ?? "Imagen"}
              width="120"
              height="60"
              loading="eager"
              src={items[0]?.src || "/placeholder.svg"}
              onerror="if(this.src!=='/favicon.svg'){this.src='/favicon.svg'}"
            />
          </div>
          <div class="gallery-overlay" aria-hidden="true" />
          <div class="gallery-caption">
            {items[0]?.title && <h3 class="caption-title">{items[0].title}</h3>}
            {items[0]?.subtitle && <p class="caption-sub">{items[0].subtitle}</p>}
          </div>
        </article>
      )
    ) : (
      <div
        id="gallery-grid"
        class="gallery-grid"
        style={`--columns: ${columns}`}
      >
        <slot />
      </div>
    )
  }
</section>

<!-- Lightbox overlay -->
<div
  id="lightbox"
  class="lightbox"
  hidden
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
>
  <button class="lightbox-close" aria-label="Cerrar">×</button>
  <div class="lightbox-content">
    <div
      id="lightbox-grid"
      class="lightbox-grid"
      style={`--columns: ${columns}`}
    >
    </div>
  </div>
</div>

<script type="module">
  // Esperar a DOMContentLoaded para asegurarnos de que Astro ya montó el HTML
  window.addEventListener("DOMContentLoaded", () => {
    // console.log("[gallery] DOM ready");

    const galleryRoot = document.querySelector(".gallery");
    if (!galleryRoot) {
      console.error("[gallery] .gallery no encontrada");
      return;
    }

    const isHero = !!document.querySelector(".gallery-item--hero");
    let itemsData = [];

    try {
      itemsData = JSON.parse(galleryRoot.dataset.items || "[]");
      // console.log("[gallery] itemsData:", itemsData);
    } catch (err) {
      console.warn("[gallery] error parseando data-items", err);
      itemsData = [];
    }

    if (isHero) {
      const hero = document.querySelector(".gallery-item--hero");
      const overlay = hero?.querySelector(".gallery-overlay");
      const caption = hero?.querySelector(".gallery-caption");
      const lb = document.getElementById("lightbox");
      const lbGrid = document.getElementById("lightbox-grid");
      const lbContent = lb?.querySelector(".lightbox-content");
      const closeBtn = lb?.querySelector(".lightbox-close");
      const heroContentDiv = document.querySelector(".hero-content");

      if (!hero) {
        console.error("[gallery] hero no encontrado");
        return;
      }
      if (!lb || !lbGrid || !lbContent) {
        console.error("[gallery] elementos del lightbox faltantes", {
          lb: !!lb,
          lbGrid: !!lbGrid,
          lbContent: !!lbContent,
        });
        return;
      }

      // Inicial
      gsap.set([overlay, caption], { autoAlpha: 0 });
      gsap.from(hero, {
        y: 30,
        autoAlpha: 0,
        duration: 0.8,
        ease: "power3.out",
      });

      let rAF = 0;
      hero.addEventListener("pointermove", (e) => {
        if (rAF) return;
        rAF = requestAnimationFrame(() => {
          const rect = hero.getBoundingClientRect();
          const cx = e.clientX - rect.left - rect.width / 2;
          const cy = e.clientY - rect.top - rect.height / 2;
          gsap.to(hero, {
            rotationY: cx / 40,
            rotationX: -cy / 40,
            scale: 1.02,
            duration: 0.18,
            ease: "power2.out",
          });
          gsap.to(overlay, { autoAlpha: 1, duration: 0.2, ease: "power2.out" });
          gsap.to(caption, {
            autoAlpha: 1,
            y: -4,
            duration: 0.2,
            ease: "power2.out",
          });
          rAF = 0;
        });
      });

      hero.addEventListener("pointerleave", () => {
        gsap.to(hero, {
          rotationX: 0,
          rotationY: 0,
          scale: 1,
          duration: 0.25,
          ease: "power2.out",
        });
        gsap.to(overlay, { autoAlpha: 0, duration: 0.2 });
        gsap.to(caption, { autoAlpha: 0, y: 0, duration: 0.2 });
      });
      hero.addEventListener("click", () => {
        // comprobaciones
        if (!lb || !lbGrid || !lbContent) return;
        if (lb.getAttribute("data-open") === "true") return; // evita re-iniciar si ya abierto

        // console.log("[gallery] abrir lightbox");

        lbGrid.innerHTML = "";

        if (heroContentDiv) {
          gsap.to(heroContentDiv, { autoAlpha: 0, duration: 0.25 });
        }

        // Crear tiles desde el DOM (excluye el hero). Si no hay, usar fallback a itemsData.
        const tiles = [];
        const mosaicPattern = ["ms-2", "ms-1", "ms-3", "ms-4", "ms-1", "ms-2"];
        const padPattern = ["pd-1", "pd-2", "pd-3", "pd-4", "pd-2", "pd-1"];

        const domTiles = Array.from(
          galleryRoot.querySelectorAll(".gallery-item")
        ).filter((el) => !el.classList.contains("gallery-item--hero"));

        if (domTiles.length) {
          domTiles.forEach((el, idx) => {
            const clone = el.cloneNode(true);
            clone.classList.remove("in-lightbox");
            // aplicar patrones opcionales
            clone.classList.add(mosaicPattern[idx % mosaicPattern.length]);
            clone.classList.add(padPattern[idx % padPattern.length]);
            lbGrid.appendChild(clone);
            tiles.push(clone);
          });
        } else {
          // Fallback a itemsData
          const srcs = itemsData.slice(1);
          srcs.forEach((it, idx) => {
            const tile = document.createElement("article");
            tile.className = "gallery-item";
            tile.setAttribute("data-id", it.id || `tile-${idx}`);
            tile.classList.add(mosaicPattern[idx % mosaicPattern.length]);
            tile.classList.add(padPattern[idx % padPattern.length]);
            const media = document.createElement("div");
            media.className = "gallery-media";
            const img = document.createElement("img");
            img.alt = it.title ?? "Imagen";
            img.loading = "lazy";
            img.src = it.src;
            img.onerror = function () {
              if (this.src !== "/favicon.svg") this.src = "/favicon.svg";
            };
            media.appendChild(img);
            tile.appendChild(media);
            lbGrid.appendChild(tile);
            tiles.push(tile);
          });
        }

        // Preparar lightbox y animar
        lb.removeAttribute("hidden");
        lb.setAttribute("aria-hidden", "false");
        lb.setAttribute("data-open", "true");
        document.documentElement.classList.add("lb-open");
        document.body.classList.add("lb-open");

        // Insertar hero CLONADO (no mover el original para no desplazar el layout)
        let heroClone = hero.cloneNode(true);
        heroClone.classList.add("in-lightbox");
        lbGrid.prepend(heroClone);

        // Crear y añadir el espacio para el texto
        const intro = document.createElement("div");
        intro.className = "lightbox-intro";
        if (heroContentDiv) {
          const cloned = heroContentDiv.cloneNode(true);
          // evita IDs duplicados
          if (cloned.id) cloned.id = `${cloned.id}-cloned`;
          intro.appendChild(cloned);
        } else {
          intro.innerHTML = `
            <div>
              <h2 class="intro-title">Galería</h2>
              <p class="intro-sub">Descripción de la imagen principal</p>
            </div>
          `;
        }
        lbGrid.insertBefore(intro, heroClone.nextSibling);

        gsap.set(lb, { autoAlpha: 0 });
        gsap.to(lb, { autoAlpha: 1, duration: 0.25, ease: "power2.out" });
        gsap.from(heroClone, { autoAlpha: 0, y: 24, duration: 0.4, ease: "power2.out" });

        // Animaciones para tiles
        gsap.set(tiles, { autoAlpha: 0, x: 60 });
        gsap.fromTo(
          tiles,
          { autoAlpha: 0, x: 60 },
          {
            autoAlpha: 1,
            x: 0,
            duration: 0.6,
            ease: "power3.out",
            stagger: 0.06,
          },
        );

        // Mapear rueda vertical a scroll horizontal
        const wheelHandler = (e) => {
          const dx = e.deltaX,
            dy = e.deltaY;
          if (Math.abs(dx) > Math.abs(dy)) return;
          if (!e.ctrlKey) {
            e.preventDefault();
            lbContent.scrollLeft += dy;
          }
        };
        lbContent.addEventListener("wheel", wheelHandler, { passive: false });

        // Close handler
        const onClose = () => {
          // console.log("[gallery] cerrar lightbox");
          // eliminar hero clonado
          if (heroClone && heroClone.parentNode) {
            heroClone.parentNode.removeChild(heroClone);
          }

          if (heroContentDiv) {
            gsap.to(heroContentDiv, { autoAlpha: 1, duration: 0.25 });
          }

          // sin Flip: cierre simple

          gsap.to(lb, {
            autoAlpha: 0,
            duration: 0.25,
            onComplete: () => {
              lb.setAttribute("hidden", "");
              lb.setAttribute("aria-hidden", "true");
              lbGrid.innerHTML = "";
              lb.removeAttribute("data-open");
              document.documentElement.classList.remove("lb-open");
              document.body.classList.remove("lb-open");
            },
          });

          lbContent.removeEventListener("wheel", wheelHandler);
          document.removeEventListener("keydown", keyHandler);
          closeBtn.removeEventListener("click", onClose);
        };

        const keyHandler = (e) => {
          if (e.key === "Escape") onClose();
          else if (e.key === "ArrowRight")
            lbContent.scrollBy({ left: 320, behavior: "smooth" });
          else if (e.key === "ArrowLeft")
            lbContent.scrollBy({ left: -320, behavior: "smooth" });
        };

        document.addEventListener("keydown", keyHandler);
        closeBtn.addEventListener("click", onClose, { once: true });
      }); // fin hero click
    } // fin isHero
    else {
      const grid = document.getElementById("gallery-grid");
      if (!grid) {
        console.error("[gallery] gallery-grid no encontrado");
        return;
      }

      // siempre re-query para evitar listas stale
      const getGridItems = () =>
        Array.from(grid.querySelectorAll(".gallery-item"));
      const gridItems = getGridItems();
      gsap.from(gridItems, {
        y: 30,
        autoAlpha: 0,
        scale: 0.98,
        duration: 0.7,
        ease: "power3.out",
        stagger: 0.05,
      });

      const shuffleGallery = () => {
        const currentItems = getGridItems();
        const state = Flip.getState(currentItems);
        const shuffled = gsap.utils.shuffle([...currentItems]);
        shuffled.forEach((el) => grid.appendChild(el));
        Flip.from(state, {
          duration: 0.6,
          ease: "power2.inOut",
          stagger: 0.02,
        });
      };

      // llamada inicial (opcional)
      shuffleGallery();

      // exponer por consola si quieres
      window.shuffleGallery = shuffleGallery;
    }
  }); // end DOMContentLoaded
</script>

<style>
  .gallery {
    display: grid;
    gap: 12px;
  }

  .gallery.gallery--hero {
    display: block;
  }

  .gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    background: #0e0e0e;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
    transform-style: preserve-3d;
    will-change: transform;
    box-sizing: border-box;
  }

  .gallery-item--hero {
    min-height: min(70vh, 680px);
    padding: 16px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .gallery-media {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-media img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .gallery-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.55) 0%,
      rgba(0, 0, 0, 0.15) 60%,
      rgba(0, 0, 0, 0) 100%
    );
    pointer-events: none;
  }

  .gallery-caption {
    position: absolute;
    left: 16px;
    bottom: 14px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
  }
  .caption-title {
    font-size: clamp(1.1rem, 2vw, 1.6rem);
    font-weight: 700;
  }
  .caption-sub {
    font-size: clamp(0.85rem, 1.6vw, 1rem);
    opacity: 0.85;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(var(--columns, 6), minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 1024px) {
    .gallery-grid {
      --columns: 4;
    }
  }
  @media (max-width: 768px) {
    .gallery-grid {
      --columns: 2;
    }
  }
  @media (max-width: 480px) {
    .gallery-grid {
      --columns: 1;
    }
  }

  /* === LIGHTBOX === */

.lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(6px);
  display: flex;
  flex-direction: column;
  height: 100vh; /* ocupa toda la pantalla vertical */
  width: 100vw;
  z-index: 1000;
  overflow: hidden;
}

.lightbox[hidden] {
  display: none;
}

/* Botón cerrar */
.lightbox-close {
  align-self: flex-end;
  margin: 16px;
  appearance: none;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 22px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  flex-shrink: 0;
}

/* === CONTENEDOR HORIZONTAL FIJO === */
.lightbox-content {
  flex: 1;
  overflow-x: auto;
  overflow-y: hidden;
  padding: 40px 48px;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 48px;
  height: 100%; /* ocupa todo el alto disponible */
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  box-sizing: border-box;
}

/* === GRID INTERNO (ahora flex horizontal) === */
.lightbox-grid {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;
  gap: 32px;
  height: 100%; /* igual al contenedor */
}

/* === IMAGEN PRINCIPAL (HERO) === */
.in-lightbox.gallery-item--hero {
  flex: 0 0 auto;
  width: clamp(520px, 56vw, 820px);
  height: 82%; /* un poco más alto */
  border-radius: 16px;
  overflow: hidden;
  background: #111;
}

.in-lightbox.gallery-item--hero .gallery-media {
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.in-lightbox.gallery-item--hero img {
  width: 100%;
  height: auto;
  object-fit: cover;
  display: block;
}

/* === BLOQUE DE TEXTO JUNTO AL HERO === */
.lightbox-intro {
  flex: 0 0 auto;
  width: clamp(420px, 48vw, 720px);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  text-align: left;
  color: #fff;
  padding: 56px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  box-sizing: border-box;
  overflow-y: auto;
}

.lightbox-intro > div {
  width: 100%;
}

.intro-title {
  font-size: clamp(1.5rem, 3vw, 2rem);
  font-weight: 700;
  margin-bottom: 24px;
}

.intro-sub {
  font-size: clamp(1rem, 1.8vw, 1.2rem);
  line-height: 1.8;
  opacity: 0.9;
}

@media (max-width: 1024px) {
  .lightbox-content {
    padding: 32px 36px;
    gap: 36px;
  }
  .in-lightbox.gallery-item--hero {
    width: clamp(420px, 60vw, 680px);
    height: 78%;
  }
  .lightbox-intro {
    width: clamp(360px, 52vw, 640px);
    padding: 44px;
  }
}

@media (max-width: 768px) {
  .lightbox-content {
    padding: 24px;
    gap: 24px;
  }
  .in-lightbox.gallery-item--hero {
    width: 85vw;
    height: auto;
  }
  .lightbox-intro {
    width: 85vw;
    padding: 28px;
  }
}

/* === MOSAICO DE IMÁGENES (RECORTADAS Y PEQUEÑAS) === */
.lightbox-grid
  .gallery-item:not(.in-lightbox.gallery-item--hero):not(.lightbox-intro) {
  position: relative;
  overflow: hidden;
  border-radius: 10px;
  background: #111;
  flex: 0 0 auto;
  scroll-snap-align: start;
}

/* Tamaños controlados */
.lightbox-grid .gallery-item.ms-1 {
  width: 180px;
  height: 180px;
}
.lightbox-grid .gallery-item.ms-2 {
  width: 220px;
  height: 160px;
}
.lightbox-grid .gallery-item.ms-3 {
  width: 200px;
  height: 260px;
}
.lightbox-grid .gallery-item.ms-4 {
  width: 260px;
  height: 140px;
}

/* Imagen recortada */
.lightbox-grid .gallery-media {
  width: 100%;
  height: 100%;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lightbox-grid .gallery-media img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* recorta */
  object-position: center;
  display: block;
  transition: transform 0.3s ease;
}

.lightbox-grid .gallery-item:hover .gallery-media img {
  transform: scale(1.05);
}

/* === SOMBRAS LATERALES DEL SCROLL === */
.lightbox-content::before,
.lightbox-content::after {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  width: 60px;
  pointer-events: none;
  z-index: 5;
}

.lightbox-content::before {
  left: 0;
  background: linear-gradient(to right, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
}
.lightbox-content::after {
  right: 0;
  background: linear-gradient(to left, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
}
  :global(html.lb-open),
  :global(body.lb-open) {
    overflow: hidden;
  }
  /* === OVERRIDES: más espacio para texto en lightbox === */
  .lightbox .lightbox-content {
    padding: 56px 64px;
    gap: 64px;
  }
  .lightbox .lightbox-grid {
    gap: 40px;
  }
  .lightbox .lightbox-intro {
    width: clamp(480px, 52vw, 800px);
    padding: 64px;
  }
  .lightbox .lightbox-intro .intro-title {
    margin-bottom: 28px;
  }
  .lightbox .lightbox-intro .intro-sub {
    line-height: 1.95;
  }
  .lightbox .lightbox-intro p {
    margin: 0 0 1rem;
  }

  /* === OVERRIDES 2: aún más espacio y sin scroll interno en el texto === */
  .lightbox .lightbox-content {
    padding: 72px 80px;
    gap: 72px;
    align-items: flex-start;
  }
  .lightbox .lightbox-grid {
    gap: 56px;
  }
  .lightbox .lightbox-intro {
    width: clamp(520px, 56vw, 880px);
    padding: 72px;
    overflow: visible;
    max-height: none;
  }
  /* opcional: si el hero es muy alto, evita forzar altura para reducir scroll anidado */
  .lightbox .in-lightbox.gallery-item--hero {
    height: auto;
    max-height: 86vh;
  }

  @media (max-width: 1024px) {
    .lightbox .lightbox-content {
      padding: 48px 56px;
      gap: 48px;
      align-items: flex-start;
    }
    .lightbox .lightbox-intro {
      width: clamp(460px, 60vw, 760px);
      padding: 56px;
    }
  }

  @media (max-width: 768px) {
    .lightbox .lightbox-content {
      padding: 28px;
      gap: 28px;
      align-items: flex-start;
    }
    .lightbox .lightbox-intro {
      width: 88vw;
      padding: 24px;
    }
  }
</style>