---
// Gallery item type definition
const GalleryItem = {
  id: "",
  src: "",
  title: "",
  subtitle: "",
};

const Props = {
  items: [],
  columns: 6,
  variant: "hero",
  layout: null,
  indices: null,
};

const defaultItems = [
  {
    id: "morty-hero",
    src: "/assets/mortySpawn.webp",
    title: "Morty Spawn",
    subtitle: "Galería",
  },
  { id: "mosaic-1", src: "/assets/torrebrujo.png", title: "Torre de Brujo" },
  { id: "mosaic-2", src: "/assets/bar.png", title: "Barra de Brujo" },
  { id: "mosaic-3", src: "assets/estatualaus.png", title: "Estatua de Laus" },
  { id: "mosaic-4", src: "assets/centroplots.png", title: "Centro de la ciudad" },
  { id: "mosaic-5", src: "assets/dragones.png", title: "Imagen 5" },
  { id: "mosaic-6", src: "assets/dragones.png", title: "Imagen 6" },
  { id: "mosaic-7", src: "assets/dragones.png", title: "Imagen 7" },
];

const {
  items = defaultItems,
  columns = 6,
  variant = items.length === 1 ? "hero" : "mosaic",
  layout = null,
  indices = null,
} = Astro.props;
---

<section
  class={`gallery gallery--${variant}`}
  aria-label="Galería de imágenes"
  data-items={JSON.stringify(items)}
>
  {
    variant === "hero" ? (
      Astro.slots.has("hero") ? (
        <slot name="hero" />
      ) : (
        <article class="gallery-item gallery-item--hero" data-id="hero-image">
          <div class="gallery-media">
            <img
              alt={items[0]?.title ?? "Imagen"}
              width="120"
              height="60"
              loading="eager"
              src={items[0]?.src || "/assets/servi.webp"}
            />
          </div>
          <div class="gallery-overlay" aria-hidden="true" />
          <div class="hero-caption-inline">Spawn Britannia CocoCraft</div>
        </article>
      )
    ) : (
      <div
        id="gallery-grid"
        class="gallery-grid"
        style={`--columns: ${columns}`}
      >
        <slot />
      </div>
    )
  }
</section>

<!-- Web Component Island for Lightbox -->
<lightbox-island
  id="lightboxIsland"
  items={JSON.stringify(items)}
  layout={JSON.stringify(layout ?? null)}
  indices={JSON.stringify(indices ?? null)}
></lightbox-island>

<!-- Client-side script for the lightbox component -->
<script>
  // This will be executed on the client side
  import './LightboxIsland.js';
</script>

<script type="module">
  // Esperar a DOMContentLoaded para asegurarnos de que Astro ya montó el HTML
  window.addEventListener("DOMContentLoaded", () => {
    // console.log("[gallery] DOM ready");

    const galleryRoot = document.querySelector(".gallery");
    if (!galleryRoot) {
      console.error("[gallery] .gallery no encontrada");
      return;
    }

    const isHero = !!document.querySelector(".gallery-item--hero");
    let itemsData = [];

    try {
      itemsData = JSON.parse(galleryRoot.dataset.items || "[]");
      // console.log("[gallery] itemsData:", itemsData);
    } catch (err) {
      console.warn("[gallery] error parseando data-items", err);
      itemsData = [];
    }

    if (isHero) {
      const hero = document.querySelector(".gallery-item--hero");
      const overlay = hero?.querySelector(".gallery-overlay");

      if (!hero) {
        console.error("[gallery] hero no encontrado");
        return;
      }
      // island-based lightbox: no DOM prerequisites

      // Inicial
      gsap.set(overlay, { autoAlpha: 0 });
      gsap.from(hero, {
        y: 30,
        autoAlpha: 0,
        duration: 0.8,
        ease: "power3.out",
      });

      let rAF = 0;
      hero.addEventListener("pointermove", (e) => {
        if (rAF) return;
        rAF = requestAnimationFrame(() => {
          const rect = hero.getBoundingClientRect();
          const cx = e.clientX - rect.left - rect.width / 2;
          const cy = e.clientY - rect.top - rect.height / 2;
          gsap.to(hero, {
            rotationY: cx / 40,
            rotationX: -cy / 40,
            scale: 1.02,
            duration: 0.18,
            ease: "power2.out",
          });
          gsap.to(overlay, { autoAlpha: 1, duration: 0.2, ease: "power2.out" });
          rAF = 0;
        });
      });

      hero.addEventListener("pointerleave", () => {
        gsap.to(hero, {
          rotationX: 0,
          rotationY: 0,
          scale: 1,
          duration: 0.25,
          ease: "power2.out",
        });
        gsap.to(overlay, { autoAlpha: 0, duration: 0.2 });
      });
      hero.addEventListener("click", () => {
        const island = document.querySelector("lightbox-island");
        if (!island) return;
        // Pasa todos los items (control selectivo por layout/indices)
        try { island.setAttribute("items", JSON.stringify(itemsData)); } catch {}
        if (typeof island.open === "function") island.open();
        else island.setAttribute("open", "");
      }); // fin hero click
    } // fin isHero
    else {
      const grid = document.getElementById("gallery-grid");
      if (!grid) {
        console.error("[gallery] gallery-grid no encontrado");
        return;
      }

      // siempre re-query para evitar listas stale
      const getGridItems = () =>
        Array.from(grid.querySelectorAll(".gallery-item"));
      const gridItems = getGridItems();
      gsap.from(gridItems, {
        y: 30,
        autoAlpha: 0,
        scale: 0.98,
        duration: 0.7,
        ease: "power3.out",
        stagger: 0.05,
      });

      const shuffleGallery = () => {
        const currentItems = getGridItems();
        const FlipLib = window.Flip;
        const state = FlipLib ? FlipLib.getState(currentItems) : null;
        const shuffled = gsap.utils.shuffle([...currentItems]);
        shuffled.forEach((el) => grid.appendChild(el));
        if (FlipLib && state) {
          FlipLib.from(state, {
            duration: 0.6,
            ease: "power2.inOut",
            stagger: 0.02,
          });
        }
      };

      // llamada inicial (opcional)
      shuffleGallery();

      // exponer por consola si quieres
      window.shuffleGallery = shuffleGallery;

      grid.addEventListener("click", (e) => {
        const item = e.target.closest(".gallery-item");
        if (!item) return;
        const island = document.querySelector("lightbox-island");
        if (!island) return;
        try { island.setAttribute("items", JSON.stringify(itemsData)); } catch {}
        if (typeof island.open === "function") island.open();
        else island.setAttribute("open", "");
      });
    }
  }); // end DOMContentLoaded
</script>

<style>
  .gallery {
    display: grid;
    gap: 12px;
  }

  .gallery.gallery--hero {
    display: block;
  }

  .gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    background: #0e0e0e;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
    transform-style: preserve-3d;
    will-change: transform;
    box-sizing: border-box;
  }

  .gallery-item--hero {
    min-height: min(70vh, 680px);
    padding: 16px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .gallery-media {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-media img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .gallery-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.55) 0%,
      rgba(0, 0, 0, 0.15) 60%,
      rgba(0, 0, 0, 0) 100%
    );
    pointer-events: none;
  }

  .hero-caption-inline {
    position: absolute;
    left: 16px;
    bottom: 14px;
    color: #fff;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(var(--columns, 6), minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 1024px) {
    .gallery-grid {
      --columns: 4;
    }
  }
  @media (max-width: 768px) {
    .gallery-grid {
      --columns: 2;
    }
  }
  @media (max-width: 480px) {
    .gallery-grid {
      --columns: 1;
    }
  }

  /* === LIGHTBOX === */
  :global(html.lb-open),
  :global(body.lb-open) {
    overflow: hidden;
  }
</style>
