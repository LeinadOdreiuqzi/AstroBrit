---
interface SkinConfig {
  id: string;
  skinPath: string;
  animation?: any;
  autoRotate?: boolean;
  cameraLightIntensity?: number;
  globalLightIntensity?: number;
  cameraPositionX?: number;
  cameraPositionY?: number;
  cameraPositionZ?: number;
  cameraLookAtX?: number;
  cameraLookAtY?: number;
  cameraLookAtZ?: number;
  // Destiny Customization
  rank?: string;
  rankTitle?: string;
  username?: string; // New field for customization
  userDescription?: string; // e.g. "Temporada 28 // R30 // L329"
  elogios?: number;
}

interface Props {
  skinsToDisplay: SkinConfig[];
  interactive?: boolean;
  width?: number;
  height?: number;
}

const {
  skinsToDisplay = [],
  interactive = false,
  width = 200,
  height = 300,
} = Astro.props;
const containerId = `skin-container-${Math.random().toString(36).substr(2, 9)}`;
---

<div id={containerId} class="skin-viewers-container">
  {
    skinsToDisplay.map((skin) => (
      <div class="skin-item" data-skin-config={JSON.stringify(skin)}>
        <canvas id={skin.id} style="pointer-events: none;" />
      </div>
    ))
  }
</div>

<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/skinview3d/bundles/skinview3d.bundle.js"
></script>
<script
  define:vars={{ skinsToDisplay, containerId, interactive, width, height }}
>
  const viewers = new Map();
  /*
    - skinview3d.IdleAnimation() : Animación de inactividad.
    - skinview3d.WalkingAnimation() : Animación de caminar.
    - skinview3d.RunningAnimation() : Animación de correr.
    - skinview3d.FlyingAnimation() : Animación de volar.
    - skinview3d.WaveAnimation() : Animación de saludar.
    - skinview3d.CrouchAnimation() : Animación de agacharse.
    - skinview3d.HitAnimation() : Animación de ser golpeado.
    */
  const initViewer = (skinConfig) => {
    const canvasElement = document.getElementById(skinConfig.id);
    if (!canvasElement) return null;

    let skinViewer;
    try {
      skinViewer = new skinview3d.SkinViewer({
        canvas: canvasElement,
        width: width,
        height: height,
      });

      // Explicitly load skin and catch every possible error
      skinViewer.loadSkin(skinConfig.skinPath).catch((e) => {
        console.error("Grid skin load failed:", e);
      });
    } catch (e) {
      console.error("Failed to create SkinViewer:", e);
      return null;
    }

    // Fix for: Uncaught TypeError: skinview3d[skinConfig.animation] is not a constructor
    if (
      skinConfig.animation &&
      typeof skinview3d[skinConfig.animation] === "function"
    ) {
      skinViewer.animation = new skinview3d[skinConfig.animation]();
    } else {
      skinViewer.animation = new skinview3d.IdleAnimation();
    }

    skinViewer.autoRotate =
      skinConfig.autoRotate !== undefined ? skinConfig.autoRotate : true;
    skinViewer.cameraLight.intensity = skinConfig.cameraLightIntensity ?? 1.9;
    skinViewer.globalLight.intensity = skinConfig.globalLightIntensity ?? 2.4;

    skinViewer.camera.position.set(
      skinConfig.cameraPositionX ?? 0,
      skinConfig.cameraPositionY ?? 15,
      skinConfig.cameraPositionZ ?? 60,
    );

    skinViewer.camera.lookAt(
      skinConfig.cameraLookAtX ?? 0,
      skinConfig.cameraLookAtY ?? 10,
      skinConfig.cameraLookAtZ ?? 0,
    );

    return skinViewer;
  };

  // Intersection Observer to handle WebGL context limit
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const id = entry.target.id;
        const config = JSON.parse(
          entry.target.parentElement.getAttribute("data-skin-config"),
        );

        if (entry.isIntersecting) {
          if (!viewers.has(id)) {
            const viewer = initViewer(config);
            if (viewer) viewers.set(id, viewer);
          }
        } else {
          if (viewers.has(id)) {
            viewers.get(id).dispose();
            viewers.delete(id);
          }
        }
      });
    },
    { rootMargin: "100px" },
  );

  // Start observing
  skinsToDisplay.forEach((skinConfig) => {
    const canvasElement = document.getElementById(skinConfig.id);
    if (canvasElement) observer.observe(canvasElement);
  });

  // Handle clicks - Scoped to this container only
  const container = document.getElementById(containerId);
  if (container && interactive) {
    const skinItems = container.querySelectorAll(".skin-item");
    skinItems.forEach((item) => {
      item.addEventListener("click", (e) => {
        e.stopPropagation();

        try {
          const config = JSON.parse(item.getAttribute("data-skin-config"));
          const lightbox = document.getElementById("global-lightbox");

          if (lightbox) {
            const itemData = {
              id: config.id,
              src: config.skinPath,
              title: "Guardian",
              subtitle: "Destiny View",
              ...config,
            };

            if (typeof lightbox.setData === "function") {
              lightbox.setData({
                mode: "destiny",
                items: [itemData],
              });
            } else {
              lightbox.setAttribute("mode", "destiny");
              lightbox.setAttribute("items", JSON.stringify([itemData]));
            }

            if (typeof lightbox.open === "function") {
              lightbox.open();
            } else {
              lightbox.setAttribute("open", "");
            }
          }
        } catch (e) {
          console.error("Error opening skin lightbox:", e);
        }
      });
    });
  }
</script>

<style>
  .skin-viewers-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 24px;
    width: 100%;
  }
  .skin-item {
    cursor: pointer;
    transition:
      transform 0.2s ease,
      filter 0.2s ease;
  }
  .skin-item:hover {
    transform: scale(1.05);
    filter: drop-shadow(0 0 8px rgba(255, 107, 0, 0.4));
  }
</style>
